// ====================================================================
// START: ALLE JAVASCRIPT CODE VOOR DE index.html
// ====================================================================

// --- DOM ELEMENTEN ---
const setupScreen = document.getElementById('setup-screen');
const gameScreen = document.getElementById('game-screen');
const playerList = document.getElementById('player-list');
const categorySelect = document.getElementById('category-select');
const startGameButton = document.getElementById('start-game-button');
const currentPlayerDisplay = document.getElementById('current-player-display');
const gameBoardContainer = document.getElementById('game-board');
const diceRollButton = document.getElementById('dice-roll-button');
const generateQuestionButton = document.getElementById('generate-question-button');
const questionTypeEl = document.getElementById('question-type');
const questionTextEl = document.getElementById('question-text');
const completedButton = document.getElementById('completed-button');
const consequenceButton = document.getElementById('consequence-button');

// --- GLOBALE SPEL STATUS ---
let players = [];
let currentPlayerIndex = 0;
let selectedCategory = 'Borrel Pulse'; 
const TOTAL_BOARD_SQUARES = 30; // Maximum vakjes voor het spelbord

// --- SETUP SCHERM FUNCTIES ---

function addPlayer() {
    const name = document.getElementById('player-name-input').value.trim();
    if (name && players.length < 8) {
        players.push({ name: name, position: 0, token: players.length + 1, skipNextTurn: false });
        document.getElementById('player-name-input').value = '';
        renderPlayerList();
    }
}

function removePlayer(index) {
    players.splice(index, 1);
    // Token nummers opnieuw toewijzen
    players.forEach((player, i) => player.token = i + 1);
    renderPlayerList();
}

function renderPlayerList() {
    playerList.innerHTML = '';
    players.forEach((player, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
            ${player.name}
            <button onclick="removePlayer(${index})">Verwijder</button>
        `;
        playerList.appendChild(li);
    });
    startGameButton.disabled = players.length < 2;
}

// --- NAVIGATIE ---

function initializeGameScreen() {
    setupScreen.style.display = 'none';
    gameScreen.style.display = 'flex';
    
    selectedCategory = categorySelect.value;
    updateCurrentPlayerUI();
    drawGameBoard();
}

// --- SPELSCHERM FUNCTIES ---

function drawGameBoard() {
    gameBoardContainer.innerHTML = '';
    
    // Vakje 0 is START
    const startSquare = document.createElement('div');
    startSquare.className = 'board-square';
    startSquare.id = `square-0`;
    startSquare.textContent = `START`;
    startSquare.style.backgroundColor = '#4CAF50';
    gameBoardContainer.appendChild(startSquare);

    for (let i = 1; i <= TOTAL_BOARD_SQUARES; i++) {
        const square = document.createElement('div');
        square.className = 'board-square';
        square.id = `square-${i}`;
        square.textContent = `Vakje ${i}`;
        
        // SPECIALE VAKJES LOGICA
        if (i === 5) {
            square.textContent = "TERUG naar Start! üîô";
            square.style.backgroundColor = '#ff4081';
        } else if (i === 10) {
            square.textContent = "3 STAPPEN VOORUIT! ‚è©";
            square.style.backgroundColor = '#00bcd4';
        } else if (i === 15) {
             square.textContent = "EXTRA SLOKKEN! ü•É";
             square.style.backgroundColor = '#ff8c00';
        } else if (i === 20) {
             square.textContent = "BEURT OVERSLAAN! üõë";
             square.style.backgroundColor = '#9c27b0';
        } else if (i === TOTAL_BOARD_SQUARES) {
            square.textContent = "FINISH üéâ";
            square.style.backgroundColor = '#FFD700'; // Goud
        }
        
        gameBoardContainer.appendChild(square);
    }
    
    updateBoardTokens();
}

function updateBoardTokens() {
    // Verwijder alle tokens
    document.querySelectorAll('.player-token').forEach(token => token.remove());

    // Plaats tokens opnieuw
    players.forEach(player => {
        const squareId = `square-${player.position}`;
        const square = document.getElementById(squareId);
        
        if (square) {
            const token = document.createElement('div');
            token.className = 'player-token';
            token.style.backgroundColor = getTokenColor(player.token); 
            token.textContent = player.token;
            square.appendChild(token);
        }
    });
}

function getTokenColor(tokenNumber) {
    const colors = ['#f44336', '#2196F3', '#4CAF50', '#FFEB3B', '#FF9800', '#9C27B0', '#00BCD4', '#8BC34A'];
    return colors[(tokenNumber - 1) % colors.length];
}

function updateCurrentPlayerUI() {
    const player = players[currentPlayerIndex];
    currentPlayerDisplay.textContent = `Aan de beurt: ${player.name} (${player.position}/${TOTAL_BOARD_SQUARES})`;
    // Schakel knoppen in voor de volgende fase
    diceRollButton.disabled = false;
    generateQuestionButton.disabled = true;
    completedButton.disabled = true;
    consequenceButton.disabled = true;
    resetQuestionContainer();
}

function resetQuestionContainer() {
    questionTypeEl.textContent = 'Dobbelen...';
    questionTextEl.textContent = 'Gooi de dobbelsteen om te bepalen hoeveel stappen je zet.';
}

// --- BEURT AFHANDELING ---

function movePlayer(steps) {
    const player = players[currentPlayerIndex];
    let newPosition = player.position + steps;
    
    if (newPosition > TOTAL_BOARD_SQUARES) {
        newPosition = TOTAL_BOARD_SQUARES; // Land precies op finish
    }
    
    player.position = newPosition;
    updateBoardTokens();
    
    // Controleer op effecten als de speler ECHT verplaatst is
    if (steps > 0) {
        checkSquareEffect(player);
    }
}

function checkSquareEffect(player) {
    const position = player.position;
    
    // Winnaars controle (moet eerst om te voorkomen dat effecten triggeren op de WIN-positie)
    if (position >= TOTAL_BOARD_SQUARES) {
        alert(`Gefeliciteerd! ${player.name} heeft het spel gewonnen! üéâ`);
        return;
    }
    
    // Speel effecten
    if (position === 5) {
        alert(`${player.name} is op het Terug naar Start vakje (${position}) beland! Ga naar vakje 1.`);
        player.position = 1;
        updateBoardTokens();
    } else if (position === 10) {
        alert(`${player.name} is op het 3 Stappen Vooruit vakje (${position}) beland! Ga 3 stappen vooruit!`);
        movePlayer(3); // Roept movePlayer opnieuw aan (kan chain-reaction veroorzaken)
    } else if (position === 15) {
         alert(`${player.name} is op het Extra Slokken vakje (${position}) beland! Neem 2 extra slokken/shots! ü•Éü•É`);
    } else if (position === 20) {
         alert(`${player.name} is op het Beurt Overslaan vakje (${position}) beland! Je slaat je volgende beurt over. üõë`);
         player.skipNextTurn = true;
    }
}

function nextTurn() {
    // Stap 1: Controleer overslaan vlag
    if (players[currentPlayerIndex].skipNextTurn) {
        players[currentPlayerIndex].skipNextTurn = false; // Reset de vlag
        alert(`${players[currentPlayerIndex].name} slaat deze beurt over (wegens vakje 20).`);
        // Ga direct door naar de volgende speler (stap 2)
    }

    // Stap 2: Index verhogen (naar de volgende speler)
    currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
    
    // Stap 3: UI updaten
    updateCurrentPlayerUI();
    updateBoardTokens();
    
    // Stap 4: Dubbel controleren of de NIEUWE speler de beurt ook moet overslaan
    if (players[currentPlayerIndex].skipNextTurn) {
        // Als de volgende speler ook moet overslaan, roep dan nextTurn direct weer aan.
        nextTurn(); 
        return; 
    }
}


// --- EVENT LISTENERS ---

// Listener voor Speler toevoegen
document.getElementById('add-player-button').addEventListener('click', addPlayer);

// Listener voor Spel Starten
startGameButton.addEventListener('click', initializeGameScreen);

// Listener voor Gooien van Dobbelsteen
diceRollButton.addEventListener('click', () => {
    const steps = Math.floor(Math.random() * 6) + 1; // Gooi 1 t/m 6
    questionTypeEl.textContent = `Je gooide een ${steps}!`;
    questionTextEl.textContent = `Ga ${steps} stappen. Klik op 'Vraag Genereren' om je opdracht te krijgen.`;
    
    movePlayer(steps); // Verplaats de speler
    
    diceRollButton.disabled = true;
    generateQuestionButton.disabled = false;
});

// --- AI LOGICA (Echte API Call naar Vercel Serverless) ---

generateQuestionButton.addEventListener('click', async () => {
     generateQuestionButton.disabled = true;
     completedButton.disabled = true;
     consequenceButton.disabled = true;
     
     questionTypeEl.textContent = 'AI WERKT...';
     questionTextEl.textContent = 'Bezig met het genereren van een unieke vraag/opdracht...';
     
     const currentPlayer = players[currentPlayerIndex];
     
     try {
         // Belangrijk: De URL is /api/generate (Vercel herkent dit als de Serverless functie)
         const response = await fetch('/api/generate', { 
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json'
             },
             body: JSON.stringify({ 
                 player: currentPlayer.name,
                 category: selectedCategory 
             })
         });
         
         if (!response.ok) {
            // Vang HTTP fouten af (zoals 500 server error)
            const errorData = await response.json();
            throw new Error(`Serverfout: ${errorData.error || 'Onbekende fout'}`);
         }
         
         const apiResult = await response.json();
         
         // Toon het resultaat van de AI
         questionTypeEl.textContent = apiResult.type.toUpperCase(); 
         questionTextEl.innerHTML = `
            ${apiResult.question} 
            <br><br> 
            <span style="font-size: 18px; font-weight: 700; color: #ffeb3b;">*Consequentie: ${apiResult.consequence}*</span>
         `;
         
         // Activeer de actieknoppen
         completedButton.disabled = false;
         consequenceButton.disabled = false;

     } catch (error) {
         // Foutafhandeling
         questionTypeEl.textContent = '‚ùå FOUT BIJ GENEREREN!';
         questionTextEl.textContent = `Er ging iets mis met de API-oproep. Controleer je Vercel logs en API Key. Details: ${error.message}`;
         console.error('API Call Fout:', error);
         
         // Heractiveer de knop om opnieuw te proberen (indien gewenst)
         generateQuestionButton.disabled = false; 
     }
});

// Listener voor Vraag Voltooid
completedButton.addEventListener('click', nextTurn);

// Listener voor Consequentie (weigeren)
consequenceButton.addEventListener('click', nextTurn);

// Initialiseer de spelerlijst bij het laden
document.addEventListener('DOMContentLoaded', renderPlayerList);

// ====================================================================
// EINDE: ALLE JAVASCRIPT CODE VOOR DE index.html
// ====================================================================